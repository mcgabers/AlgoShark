// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id @default(cuid())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  email         String       @unique
  name          String?
  walletAddress String       @unique
  profile       Json?        // Stores bio, expertise, social links
  projects      Project[]    // Projects created by user
  investments   Investment[] // Investments made by user
  votes         Vote[]       // Votes cast by user
  delegatedTo   User?        @relation("Delegation", fields: [delegateId], references: [id])
  delegateId    String?
  delegators    User[]       @relation("Delegation")
  proposals     Proposal[]   // Proposals created by user
  reviewedDiligence    DueDiligence[] @relation("ReviewedDiligence")
  diligenceComments    DueDiligenceComment[]
  diligenceReviews     DueDiligenceReview[]
}

model Project {
  id              String       @id @default(cuid())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  title           String
  description     String
  fundingGoal     Float
  currentFunding  Float       @default(0)
  category        String
  tags            String[]
  githubUrl       String
  assetId         Int         @unique
  tokenPrice      Float
  tokensAvailable Int
  status          String      @default("pending") // pending, active, completed
  metadata        Json?       // Stores stage, round, tech stack, team, roadmap, metrics
  creator         User        @relation(fields: [creatorId], references: [id])
  creatorId       String
  investments     Investment[]
  proposals       Proposal[]
  dueDiligence        DueDiligence?
  tokenMetadata    Json?    // Stores token configuration and metadata
  dividendSettings Json?    // Stores dividend configuration (frequency, thresholds, etc.)
  distributions    DividendDistribution[]
}

model Investment {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  amount       Float
  tokenAmount  Int
  metadata     Json?    // Stores strategy, round, expectations, evaluation criteria
  investor     User     @relation(fields: [investorId], references: [id])
  investorId   String
  project      Project  @relation(fields: [projectId], references: [id])
  projectId    String
}

model Proposal {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  type        String   // FUNDING, GOVERNANCE, TECHNICAL
  status      String   @default("pending") // pending, active, completed
  parameters  Json?    // Stores voting parameters and type-specific details
  creator     User     @relation(fields: [creatorId], references: [id])
  creatorId   String
  project     Project  @relation(fields: [projectId], references: [id])
  projectId   String
  votes       Vote[]
}

model Vote {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  choice      String   // YES, NO, ABSTAIN
  power       Int
  metadata    Json?    // Stores rationale, concerns, suggestions
  voter       User     @relation(fields: [voterId], references: [id])
  voterId     String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  proposalId  String
}

model ContractVersion {
  id          String   @id @default(cuid())
  contractId  String
  version     String
  sourceCode  String
  bytecode    String
  timestamp   DateTime @default(now())
  status      String   @default("inactive") // active, inactive, deprecated
  changes     String[]
  metadata    Json?
  createdBy   String
  updatedAt   DateTime @updatedAt

  @@unique([contractId, version])
  @@index([contractId, status])
}

model DueDiligence {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  project       Project  @relation(fields: [projectId], references: [id])
  projectId     String   @unique
  status        String   @default("pending") // pending, in_review, approved, rejected
  reviewer      User?    @relation("ReviewedDiligence", fields: [reviewerId], references: [id])
  reviewerId    String?
  codeAnalysis  Json?    // Automated code analysis results
  legalChecks   Json?    // Legal compliance checklist results
  securityAudit Json?    // Security audit results
  comments      DueDiligenceComment[]
  reviews       DueDiligenceReview[]
}

model DueDiligenceComment {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  content        String
  dueDiligence   DueDiligence @relation(fields: [dueDiligenceId], references: [id])
  dueDiligenceId String
  author         User         @relation(fields: [authorId], references: [id])
  authorId       String
  parentId       String?      // For threaded comments
  resolved       Boolean      @default(false)
}

model DueDiligenceReview {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  category       String       // code, legal, security, business
  status         String       // pending, approved, rejected
  findings       Json
  dueDiligence   DueDiligence @relation(fields: [dueDiligenceId], references: [id])
  dueDiligenceId String
  reviewer       User         @relation(fields: [reviewerId], references: [id])
  reviewerId     String
}

model TokenTransaction {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  type        String   // purchase, transfer, sale
  amount      Float
  price       Float?
  fromAddress String
  toAddress   String
  assetId     Int
  status      String   @default("pending") // pending, completed, failed
  txId        String   @unique
  metadata    Json?
}

model TokenAction {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  type          String   // freeze, unfreeze, clawback
  assetId       Int
  targetAddress String
  status        String   @default("pending") // pending, completed, failed
  txId          String   @unique
  metadata      Json?
}

model TokenMetrics {
  id                String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  assetId          Int      @unique
  totalHolders     Int
  totalSupply      Float
  circulatingSupply Float
  dailyVolume      Float
  dailyTransactions Int
  lastUpdated      DateTime
}

model DividendDistribution {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  timestamp   DateTime @default(now())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  assetId     Int
  amount      Float
  status      String   @default("pending") // pending, processing, completed, failed
  metadata    Json?
  payments    DividendPayment[]
}

model DividendPayment {
  id             String              @id @default(cuid())
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  timestamp      DateTime            @default(now())
  distribution   DividendDistribution @relation(fields: [distributionId], references: [id])
  distributionId String
  holderAddress  String
  amount         Float
  status         String              @default("pending") // pending, completed, failed
  txId           String?
  metadata       Json?

  @@index([holderAddress])
  @@index([distributionId, status])
} 